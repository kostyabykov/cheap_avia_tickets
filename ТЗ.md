# Техническое задание на разработку асинхронного скрипта для сбора, агрегации и мониторинга аномально низких цен авиабилетов

## 1. Введение

Данный скрипт предназначен для:
- **Постоянного сбора данных** о стоимости авиабилетов с использованием Aviasales API;
- **Хранения сырых данных** в базе данных SQLite;
- **Ежесуточного агрегирования** собранных данных в сводную таблицу;
- **Мониторинга аномально низких цен** с учетом ряда параметров, включая количество дней между рейсами (для round-trip);
- **Отправки уведомлений (alert)** ботом в Telegram в специальный канал при обнаружении аномально низкой цены.

Скрипт работает асинхронно на Python 3.12, с использованием следующих библиотек:
- `aiohttp` – для асинхронных HTTP-запросов;
- `aiolimiter` – для ограничения количества API-запросов (до 200 в минуту);
- Асинхронной версии `SQLAlchemy` (с движком `aiosqlite`) – для работы с базой данных;
- `aiogram` версии 3.x – для интеграции с Telegram Bot API.

## 2. Общая архитектура проекта

Проект состоит из трех основных модулей, работающих параллельно:

1. **Модуль сканирования (`scanning_loop`):**
   - Постоянно собирает данные с Aviasales API по заданным направлениям и диапазону дат.
   - Выполняет запросы для двух сценариев:
     - **Прямой поиск:** из городов отправления (из списка `origins`) в города назначения (из списка `destinations`):
       - One-way запросы (каждый день в диапазоне от завтрашнего дня до 30 дней вперёд).
       - Round-trip запросы (для каждого дня вылета с обратными датами, вычисляемыми как дата вылета + сдвиги: 6, 7, 8, 9, 10 или 12 дней).
     - **Обратный поиск:** из городов назначения (из списка `destinations`) в города отправления (из списка `origins`):
       - Выполняется только поиск one-way.
   - Каждому round-trip запросу дополнительно вычисляется параметр `days_between` (количество дней между датой вылета и датой обратного рейса).
   - Все запросы выполняются асинхронно с использованием пакетного запуска (например, по 100 задач) и ограничиваются до 200 API-запросов в минуту с помощью `aiolimiter`.
   - Полученные данные сохраняются в таблицу `flights`.

2. **Модуль ежедневного агрегирования (`daily_summary_loop`):**
   - Раз в сутки (с интервалом 24 часа) агрегирует данные за предыдущий день.
   - Из таблицы `flights` выбираются записи, где `timestamp` соответствует вчерашней дате (UTC, формат YYYY-MM-DD).
   - Данные группируются по следующим параметрам: `departure_from`, `departure_to`, `date_from`, `date_to`, `one_way` и **`days_between`**.
   - Для каждой группы вычисляется минимальная цена, и результаты сохраняются в таблицу `flights_days`.

3. **Модуль мониторинга аномально низких цен:**
   - Для каждого нового предложения (либо пакетно после каждого цикла сканирования) происходит сравнение стоимости билета с историческими данными из таблицы `flights_days` за последние 30 дней.
   - Группировка исторических данных осуществляется по: `departure_from`, `departure_to`, `transfers_cnt`, `one_way` и **`days_between`**.
   - Предложение считается аномально низким, если его стоимость ниже 70% от медианы (или среднего) исторических цен для соответствующей группы.
   - При обнаружении аномалии бот (на базе `aiogram` 3.x) отправляет уведомление в заданный Telegram-канал. Уведомление включает ссылку на билет и подробную информацию о рейсе.

## 3. Функциональные требования

### 3.1 Сбор данных (Scanning Loop)

- **Источник данных:**  
  Aviasales API – `https://api.travelpayouts.com/aviasales/v3/prices_for_dates`.

- **Параметры поиска:**

  **Прямой поиск (из `origins` → `destinations`):**
  - Города отправления: список `origins` (например, "MOW", "LED").
  - Города назначения: список `destinations` (например, "DXB", "HKT", "BKK", "SIN", "AYT", "SIN", "DPS").
  - Для каждого направления выполняются:
    - **One-way:** для каждого дня в диапазоне от завтрашнего дня до 30 дней вперёд.
    - **Round-trip:** для каждого дня вылета с обратной датой, равной дате вылета плюс один из сдвигов: 6, 7, 8, 9, 10 или 12 дней.
    - Для round-trip дополнительно вычисляется параметр `days_between` (разница в днях между датой обратного рейса и датой вылета).

  **Обратный поиск (из `destinations` → `origins`):**
  - Выполняется только поиск one-way (без round-trip), чтобы исключить рейсы между городами-отправлениями.

- **Обработка ответа API:**
  - Из ответа API извлекаются варианты перелётов.
  - Принимаются только варианты с количеством пересадок 0, 1 или 2.
  - Извлекаются следующие параметры:
    - `timestamp` – время получения данных (UTC, ISO формат).
    - `departure_from` – IATA код города отправления.
    - `departure_to` – IATA код города назначения.
    - `date_from` – дата вылета.
    - `date_to` – дата обратного рейса (для round-trip; для one-way — NULL).
    - `transfers_cnt` – количество пересадок.
    - `one_way` – тип рейса (True для one-way, False для round-trip).
    - `price` – стоимость билета.
    - **`days_between`** – для round-trip вычисляется как разница между `date_to` и `date_from` (в днях); для one-way — NULL.

- **Хранение:**  
  Все полученные данные сохраняются в таблицу `flights` базы данных SQLite.

- **Лимитирование:**  
  Используется `aiolimiter` для ограничения числа API-запросов до 200 в минуту.

### 3.2 Ежесуточное агрегирование (Daily Summary)

- **Цель агрегирования:**  
  Из таблицы `flights` за вчерашний день (определяется по `timestamp` в формате YYYY-MM-DD UTC) агрегировать данные.

- **Группировка:**  
  Группировка производится по:
  - `departure_from`,  
  - `departure_to`,  
  - `date_from`,  
  - `date_to`,  
  - `one_way`,  
  - **`days_between`**.

- **Агрегация:**  
  Для каждой группы вычисляется минимальная стоимость перелёта (`min_price`).

- **Хранение:**  
  Результаты сохраняются в таблицу `flights_days` с полями:
  - `aggregation_date` – дата агрегирования (в данном случае, вчерашняя дата).
  - `departure_from`, `departure_to`, `date_from`, `date_to`, `one_way`, **`days_between`**.
  - `min_price` – минимальная стоимость в группе.

- **Периодичность:**  
  Агрегация происходит раз в сутки (с интервалом 24 часа).

### 3.3 Мониторинг аномально низких цен и Telegram-уведомления

- **Цель:**  
  Для каждого нового предложения, полученного в рамках сканирования, происходит сравнение цены с историческими данными из `flights_days` за последние 30 дней.

- **Параметры сравнения:**  
  Группировка исторических данных производится по:
  - `departure_from`,  
  - `departure_to`,  
  - `transfers_cnt`,  
  - `one_way`,  
  - **`days_between`**.

- **Критерий аномальности:**  
  Предложение считается аномально низким, если его цена ниже 70% от медианы (или среднего) исторических цен для соответствующей группы.

- **Уведомления:**  
  При обнаружении аномалии отправляется уведомление в Telegram через бота:
  - Используются `aiogram` версии 3.x, Telegram Bot API Token и Telegram Channel ID (или chat_id канала).
  - Уведомление содержит:
    - Ссылку на билет.
    - Информацию о рейсе: города отправления и назначения, даты вылета и обратного рейса (если применимо), количество пересадок, тип рейса, значение `days_between` и стоимость билета.

## 4. Архитектура проекта

### 4.1 Общая архитектура

Проект реализован как асинхронное приложение на Python 3.12, использующее модульную архитектуру. Основные компоненты:
- **Сбор данных (Scanning Loop):**  
  - Отвечает за периодический запуск API-запросов по заданным направлениям.
  - Выполняет прямой и обратный поиск (one-way и round-trip, где применимо) с расчетом дополнительных параметров.
  - Обеспечивает пакетное выполнение задач с ограничением запросов.
- **Ежесуточное агрегирование (Daily Summary):**  
  - Раз в сутки анализирует собранные данные, группирует их и вычисляет минимальные цены.
  - Результаты сохраняются в отдельную таблицу для последующего анализа.
- **Мониторинг аномалий:**  
  - Проводится параллельно со сбором данных.
  - Для каждого нового предложения производится сравнение с историческими данными.
  - В случае обнаружения аномалии отправляются уведомления через Telegram.
- **Telegram Bot:**  
  - Интегрирован с использованием `aiogram` версии 3.x для отправки алертов в заданный канал.

Коммуникация между модулями происходит через общую базу данных (SQLite), а асинхронное выполнение обеспечивается модулем `asyncio`.

### 4.2 Архитектура базы данных

База данных SQLite содержит две основные таблицы:

#### Таблица `flights`
- **Назначение:** Хранение сырых данных, полученных с Aviasales API.
- **Поля:**
  - `id` – INTEGER, первичный ключ.
  - `timestamp` – STRING: время получения данных (UTC, ISO формат).
  - `departure_from` – STRING: IATA код города отправления.
  - `departure_to` – STRING: IATA код города назначения.
  - `date_from` – STRING: дата вылета (YYYY-MM-DD).
  - `date_to` – STRING, nullable: дата обратного рейса (YYYY-MM-DD) или NULL для one-way.
  - `transfers_cnt` – INTEGER: количество пересадок (0, 1 или 2).
  - `one_way` – BOOLEAN: True для one-way, False для round-trip.
  - `price` – INTEGER: стоимость билета в рублях.
  - **`days_between`** – INTEGER, nullable: количество дней между датой обратного рейса и датой вылета (для round-trip), NULL для one-way.

#### Таблица `flights_days`
- **Назначение:** Хранение агрегированных данных за предыдущий день.
- **Поля:**
  - `id` – INTEGER, первичный ключ.
  - `aggregation_date` – STRING: дата агрегирования (YYYY-MM-DD).
  - `departure_from` – STRING.
  - `departure_to` – STRING.
  - `date_from` – STRING.
  - `date_to` – STRING, nullable.
  - `one_way` – BOOLEAN.
  - **`days_between`** – INTEGER, nullable: количество дней между рейсами для round-trip, NULL для one-way.
  - `min_price` – INTEGER: минимальная стоимость перелёта в группе.

## 5. Технические требования

### 5.1 Стек технологий
- **Язык:** Python 3.12.
- **Асинхронные библиотеки:**  
  — `asyncio`  
  — `aiohttp` (для HTTP-запросов)  
  — `aiolimiter` (для ограничения API-запросов)
- **База данных:** SQLite с использованием `aiosqlite`.
- **ORM:** SQLAlchemy (асинхронная версия).
- **Telegram Bot:** `aiogram` версии 3.x.

### 5.2 Конфигурационные параметры
- **API Aviasales:**  
  - URL: `https://api.travelpayouts.com/aviasales/v3/prices_for_dates`  
  - API Token (настраиваемый параметр).
- **Списки городов:**  
  - `origins`: ["MOW", "LED"]
  - `destinations`: ["DXB", "HKT", "BKK", "SIN", "AYT", "SIN", "DPS"]
- **Диапазон дат:**  
  - Даты вылета: от завтрашнего дня до 30 дней вперёд.
  - Для round-trip: обратная дата = дата вылета + [6, 7, 8, 9, 10, 12] дней.
- **Критерий аномальности:**  
  - Цена предложения считается аномально низкой, если она ниже 70% от медианы (или среднего) исторических цен за последние 30 дней для соответствующей группы (с учетом `days_between`).
- **Telegram уведомления:**  
  - Telegram Bot API Token.
  - Telegram Channel ID (chat_id канала).

## 6. Логика работы и компоненты кода

### 6.1 Инициализация базы данных (`init_db`)
- Создаются таблицы `flights` и `flights_days`, если они не существуют.

### 6.2 Сбор данных (Scanning Loop)
- **Диапазон дат:** от завтрашнего дня до 30 дней вперёд.
- **Запросы:**
  - Прямой поиск: из `origins` → `destinations`:
    - One-way: 30 запросов.
    - Round-trip: 30 × 6 = 180 запросов (с вычислением `days_between`).
  - Обратный поиск: из `destinations` → `origins`:
    - Только one-way: 30 запросов.
- **Лимитирование:**  
  Все запросы ограничиваются до 200 API-запросов в минуту.
- **Сохранение:**  
  Ответы API сохраняются в таблицу `flights` с вычислением `days_between` для round-trip.

### 6.3 Ежесуточное агрегирование (Daily Summary)
- **Сбор данных:**  
  Выбираются записи из `flights` за вчерашний день (по `timestamp`).
- **Группировка:**  
  По `departure_from`, `departure_to`, `date_from`, `date_to`, `one_way` и `days_between`.
- **Агрегация:**  
  Вычисляется минимальная цена (`min_price`) для каждой группы.
- **Сохранение:**  
  Результаты записываются в таблицу `flights_days` с указанием `aggregation_date`.

### 6.4 Мониторинг аномалий и Telegram-уведомления
- **Проверка аномалий:**  
  Для каждого нового предложения выполняется сравнение с историческими данными из `flights_days` за последние 30 дней с учетом параметров: `departure_from`, `departure_to`, `transfers_cnt`, `one_way` и `days_between`.
- **Критерий:**  
  Предложение считается аномально низким, если его цена ниже 70% от медианы (или среднего) исторических значений.
- **Уведомление:**  
  При обнаружении аномалии бот на базе `aiogram` версии 3.x отправляет сообщение в Telegram-канал, включающее:
  - Ссылку на билет.
  - Информацию о рейсе: города, даты, количество пересадок, тип рейса, `days_between`, стоимость.

### 6.5 Основная функция (`main`)
- Инициализирует базу данных.
- Параллельно запускает модули:
  - `scanning_loop` – постоянный сбор данных.
  - `daily_summary_loop` – ежедневное агрегирование.
  - Мониторинг аномалий интегрируется в процесс сканирования или вызывается пакетно.

## 7. Заключение

Реализованный скрипт обеспечивает:
- **Постоянный асинхронный сбор данных** о стоимости авиабилетов для заданных направлений с использованием Aviasales API.
- **Сохранение детальных данных** в таблицу `flights` с учетом вычисляемого параметра `days_between` для round-trip.
- **Ежесуточное агрегирование** данных за предыдущий день с группировкой по всем ключевым параметрам, включая `days_between`, и сохранением минимальной цены в таблицу `flights_days`.
- **Мониторинг аномально низких цен,** где новое предложение сравнивается с историческими данными (за последние 30 дней) с учетом `days_between`, и при обнаружении аномалии отправляется уведомление в Telegram-канал через бота (aiogram 3.x).
- **Соблюдение лимита** 200 API-запросов в минуту с помощью `aiolimiter`.
- **Использование актуальных технологий**: Python 3.12, aiogram 3.x, asyncio, aiohttp, асинхронная версия SQLAlchemy и aiosqlite.

Данное техническое задание, включающее описание архитектуры проекта и базы данных, служит подробным руководством для разработки, тестирования и поддержки проекта по сбору, агрегации и мониторингу аномально низких цен авиабилетов.
